ensure-builder-image-cache:
  description: >
    Ensure all intermediate build images are cached appropriately.
    Use this in an earlier job than ensure-static-builder to make sure
    all builder caches are up to date. Because we specifically build
    each image archive here, we can be sure they are restorable.
  steps:
    - restore-each-builder-cache
    - run: make -f release.Makefile base-archive
    - run: make -f release.Makefile ui-deps-archive
    - run: make -f release.Makefile static-archive
    - save-builder-cache

ensure-static-builder:
  description: >
    Ensures the static builder image is available (prefers cache but will rebuild it if necessary).
    Use this to prepare the builder for building final packages.
  steps:
    - restore-builder-cache
    - run: make -f release.Makefile static

restore-each-builder-cache:
  description: >
    Restore each separate cached archive so we can just update those layers that need it.
  steps:
    - write-cache-key:
        layer-name: static
    - write-cache-key:
        layer-name: ui-deps
    - write-cache-key:
        layer-name: base
    - restore_cache:
        key: &BASE_CACHE_KEY base-archive-v1-{{ checksum ".buildcache/base-cache-key" }}
    - restore_cache:
        key: &UI_DEPS_CACHE_KEY ui-deps-archive-v1-{{ checksum ".buildcache/ui-deps-cache-key" }}
    - restore_cache:
        key: &STATIC_CACHE_KEY static-archive-v1-{{ checksum ".buildcache/static-cache-key" }}

restore-builder-cache:
  description: >
    Just restore the most specific cache that exists, not intermediate caches.
    This is what you need to build packages.
  steps:
    - write-cache-key:
        layer-name: static
    - write-cache-key:
        layer-name: ui-deps
    - write-cache-key:
        layer-name: base
    - restore_cache:
        keys:
          - *STATIC_CACHE_KEY
          - *UI_DEPS_CACHE_KEY
          - *BASE_CACHE_KEY

save-builder-cache:
  steps:
    - save_cache:
        key: *BASE_CACHE_KEY
        paths:
          - .buildcache/base
    - save_cache:
        key: *UI_DEPS_CACHE_KEY
        paths:
          - .buildcache/ui-deps
    - save_cache:
        key: *STATIC_CACHE_KEY
        paths:
          - .buildcache/static

write-cache-key:
  parameters:
    layer-name:
      type: string
  steps:
    - run:
        name: Generate <<parameters.layer-name>> image cache key.
        environment:
          NAME: <<parameters.layer-name>>
        command: |
          mkdir -p .buildcache
          FILE=.buildcache/$NAME-cache-key
          make -f release.Makefile $NAME-archive-name > $FILE
          echo "Cache key for layer $NAME is $(cat $FILE); written to $FILE"
