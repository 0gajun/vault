<Modal
  @title="Generate operation token"
  @onClose={{action 'onCancelClose'}}
  @isActive={{isActive}}
  @type="warning"
  @showCloseButton={{true}}
>
  <section class="modal-card-body">
    {{#if encoded_token}}
      <div class="has-bottom-margin-m">
        <div class="message is-list has-copy-button" tabindex="-1">
          <HoverCopyButton @copyValue={{encoded_token}} />
          <div class="message-body">
            <h4 class="title is-7 is-marginless">
              Encoded operation token
            </h4>
            <code class="is-word-break">{{encoded_token}}</code>
          </div>
        </div>
        {{#if otp}}
          <p>IS OTP</p>
          <div class="message is-list has-copy-button" tabindex="-1">
            <HoverCopyButton @copyValue={{otp}} />
            <div class="message-body">
              <h4 class="title is-7 is-marginless">
                One Time Password (otp)
              </h4>
              <code class="is-word-break">{{otp}}</code>
            </div>
          </div>
        {{/if}}
          <div class="message is-list has-copy-button" tabindex="-1">
            {{#let (if otp
              (concat 'vault operator generate-root -otp="' otp '" -decode="' encoded_token '"') (concat 'vault operator generate-root -otp="<enter your otp here>" -decode="' encoded_token '"') ) as |cmd|}}
              <HoverCopyButton @copyValue={{cmd}} />
              <div class="message-body">
                <h4 class="title is-7 is-marginless">
                  DR operation token Command
                </h4>
                <code class="is-word-break">{{cmd}}</code>
              </div>
            {{/let}}
          </div>
      </div>
      <div>
        <button type="button" class="button" {{action 'reset'}}>
          Clear Token
        </button>
      </div>
    {{else if (and generateAction (not started))}}
    <form {{action 'startGenerate' (hash pgp_key=pgp_key) on="submit"}} id="shamir">
      {{message-error errors=errors}}
      {{#if (eq generateStep 'chooseMethod')}}
        <div class="has-bottom-margin-m">
          <p>
          Updating or promoting this cluster requires an operation token. Let's generate one by
          inputting the master key shares. If you'd like to encrypt the token with a PGP Key, please click "Provide PGP Key" below, otherwise we can begin generation of the operation token.
          </p>
        </div>
        <div class="field is-grouped">
          <div class="control is-flex-row">
            <button type="button" class="link" {{action (mut generateWithPGP) true}}>
              Provide PGP Key
            </button>
          </div>
          <div class="control">
            <span class="button auto-width is-white is-static">
              or
            </span>
          </div>
          <div class="control">
            <button type="submit" class="button is-primary">
              Generate operation token
            </button>
          </div>
        </div>
      {{/if}}
      {{#if (eq generateStep 'providePGPKey')}}
        <div class="has-bottom-margin-m">
          <p>
            Choose a PGP Key from your computer or paste the contents of one in the form below.
            This key will be used to Encrypt the generated operation token.
          </p>
          {{pgp-file index='' key=pgpKeyFile onChange=(action 'setKey')}}
        </div>
        <div class="field is-grouped">
          <div class="control">
            <button type="button" class="button" {{action "reset"}}>
              Back
            </button>
          </div>
          <div class="control">
            <button type="button" disabled={{not pgp_key}} class="button is-primary" {{action "savePGPKey"}}>
              Use PGP Key
            </button>
          </div>
        </div>
      {{/if}}
      {{#if (eq generateStep 'beginGenerationWithPGP')}}
        <div class="box is-marginless is-shadowless {{if paddingless 'is-paddingless'}}">
          <p>
            Below is the base-64 encoded PGP Key that will be used to encrypt the generated operation token.
            Next we'll enter portions of the master key to generate an operation token. Click the "Generate operation token" button to proceed.
          </p>
          <div class="message is-list has-copy-button" tabindex="-1">
            <HoverCopyButton @copyValue={{pgp_key}} />
            <div class="message-body">
              <h4 class="title is-7 is-marginless">
                PGP Key {{pgpKeyFile.fileName}}
              </h4>
              <code class="is-word-break">{{pgp_key}}</code>
            </div>
          </div>
        </div>
        <div class="field is-grouped box is-marginless is-shadowless">
          <div class="control">
            <button type="button" class="button" {{action "reset"}}>
              Back
            </button>
          </div>
          <div class="control">
            <button type="submit" disabled={{and (not pgp_key)}} class="button is-primary">
              Generate operation token
            </button>
          </div>
        </div>
      {{/if}}
    </form>
    {{else}}
      <form {{action 'onSubmit' (hash key=key) on="submit"}} id="shamir">
        <div class="has-bottom-margin-m">
          {{#if errors}}
            <div class="box is-shadowless is-marginless no-padding-top is-fullwidth">
              {{message-error errors=errors}}
            </div>
          {{/if}}
          <div class="box is-shadowless is-marginless no-padding-top is-fullwidth no-padding-sides" data-test-form-text>
            {{#if otp}}
              <p>
                <AlertBanner @type="info" @message="Below is the generated OTP. This will be used to encode the generated operation token. Make sure to save this, as you will need it later to decode the operation token." />
              </p>
              <div class="message is-list has-copy-button" tabindex="-1">
                <HoverCopyButton @copyValue={{otp}} />
                <div class="message-body">
                  <h4 class="title is-7 is-marginless">
                    One Time Password (otp)
                  </h4>
                  <code class="is-word-break">{{otp}}</code>
                </div>
              </div>
            {{/if}}
            {{#if (has-block)}}
              {{yield}}
            {{else if formText}}
              {{formText}}
            {{/if}}
          </div>
          <div class="field {{if paddingless 'has-margin-top'}}">
            <label for="key" class="is-label">
              Master Key Portion
            </label>
            <div class="control">
              {{input class="input"type="password" name="key" value=key data-test-shamir-input=true}}
            </div>
          </div>
        </div>
        <div class="has-bottom-margin-m">
          <div class="columns is-mobile">
            <div class="column is-narrow">
              <button
                type="submit"
                class="button is-primary"
                disabled={{loading}}
                data-test-shamir-submit=true
              >
                {{if generateAction "Generate Token" buttonText}}
              </button>
            </div>
            <div class="column is-flex-v-centered is-flex-end">
              {{#if (or started hasProgress)}}
                <ShamirProgress
                  @threshold={{threshold}}
                  @progress={{progress}}
                />
              {{/if}}
            </div>
          </div>
        </div>
      </form>
    {{/if}}
  </section>
  <footer class="modal-card-foot modal-card-foot-outlined">
    <button
      class="button is-secondary"
      onclick={{action 'onCancelClose'}}
      data-test-shamir-modal-cancel-button
    >
      Cancel
    </button>
  </footer>
</Modal>